<%- include('partials/header') %>

<h3 class="mb-3 text-center fw-bold">Citas del d√≠a <%= fecha %></h3>

<div class="text-center mb-3">
  <a href="/" class="btn btn-outline-primary rounded-pill px-4 py-2">
    &laquo; Volver al calendario
  </a>
</div>

<div class="row g-4">
  <!-- üìÖ Nueva cita -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="mb-3 fw-semibold text-primary">Nueva cita</h5>
        <form action="/citas" method="post" class="row g-2">
          <input type="hidden" name="fecha" value="<%= fecha %>">
          <div class="col-12">
            <label class="form-label">Nombre</label>
            <input type="text" name="nombre" class="form-control" required />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Tel√©fono</label>
            <input type="text" name="telefono" class="form-control" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Hora</label>
            <select name="hora" class="form-select" required>
              <option value="">Seleccione hora...</option>
              <% horarios.forEach(h => { %>
                <option value="<%= h %>"><%= h %></option>
              <% }) %>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">Lugar</label>
            <% if (lugares && lugares.length > 0) { %>
              <select name="lugar" class="form-select" required>
                <% lugares.forEach(l => { %>
                  <option value="<%= l.nombre %>"><%= l.nombre %></option>
                <% }) %>
              </select>
            <% } else { %>
              <div class="alert alert-warning small mt-1">
                No hay lugares en el cat√°logo.
              </div>
            <% } %>
          </div>
          <div class="col-12 mt-3">
            <button class="btn btn-primary w-100 fw-semibold py-2 rounded-pill" type="submit">
              Guardar cita
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- üìã Citas registradas -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="mb-3 fw-semibold text-primary">Citas registradas</h5>

        <% if (!citas || citas.length === 0) { %>
          <div class="alert alert-info text-center py-3">
            No hay citas registradas para este d√≠a.
          </div>
        <% } else { %>
          <div class="table-responsive">
            <table class="table table-striped align-middle mb-0">
              <thead>
                <tr class="text-center">
                  <th>Hora</th>
                  <th>Nombre</th>
                  <th>Tel√©fono</th>
                  <th>Lugar</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <% citas.forEach(c => { %>
                  <tr>
                    <td class="fw-bold">
                      <%= (typeof c.hora === 'string') ? c.hora.slice(0,5) : new Date(c.hora).toTimeString().slice(0,5) %>
                    </td>
                    <td><%= c.nombre %></td>
                    <td><%= c.telefono %></td>
                    <td><%= c.lugar %></td>
                    <td class="text-center">
                      <div class="acciones-cita d-flex flex-wrap justify-content-center gap-2">
                        <button class="btn btn-sm btn-outline-secondary btn-accion"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#edit-<%= c.id %>">
                          ‚úèÔ∏è Editar
                        </button>
                        <form action="/citas/<%= c.id %>/eliminar" method="post"
                              onsubmit="return confirm('¬øEliminar cita?');" class="m-0">
                          <input type="hidden" name="fecha" value="<%= fecha %>">
                          <button class="btn btn-sm btn-outline-danger btn-accion" type="submit">
                            üóëÔ∏è Eliminar
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>

                  <!-- üîß Formulario de edici√≥n -->
                  <tr class="collapse" id="edit-<%= c.id %>">
                    <td colspan="5">
                      <form action="/citas/<%= c.id %>/editar" method="post" class="row g-2">
                        <div class="col-12 col-md-6">
                          <label class="form-label">Nombre</label>
                          <input type="text" name="nombre" class="form-control" value="<%= c.nombre %>" required />
                        </div>
                        <div class="col-12 col-md-3">
                          <label class="form-label">Tel√©fono</label>
                          <input type="text" name="telefono" class="form-control" value="<%= c.telefono %>" />
                        </div>
                        <div class="col-12 col-md-3">
                          <label class="form-label">Hora</label>
                          <select name="hora" class="form-select" required>
                            <% 
                              const horaActual = (typeof c.hora === 'string')
                                ? c.hora.slice(0,5)
                                : new Date(c.hora).toTimeString().slice(0,5);
                            %>
                            <% horarios.forEach(h => { %>
                              <option value="<%= h %>" <%= h === horaActual ? 'selected' : '' %>>
                                <%= h %>
                              </option>
                            <% }) %>
                          </select>
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label">Lugar</label>
                          <% if (lugares && lugares.length > 0) { %>
                            <select name="lugar" class="form-select" required>
                              <% lugares.forEach(l => { %>
                                <option value="<%= l.nombre %>" <%= l.nombre === c.lugar ? 'selected' : '' %>>
                                  <%= l.nombre %>
                                </option>
                              <% }) %>
                            </select>
                          <% } else { %>
                            <input type="text" name="lugar" class="form-control" value="<%= c.lugar %>" />
                          <% } %>
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label">Fecha</label>
                          <input type="date" name="fecha" class="form-control"
                                 value="<%= (c.fecha && c.fecha.toISOString) 
                                   ? c.fecha.toISOString().slice(0,10)
                                   : new Date(c.fecha).toISOString().slice(0,10) %>" required />
                        </div>
                        <div class="col-12 mt-3">
                          <button class="btn btn-success w-100 fw-semibold rounded-pill py-2" type="submit">
                            üíæ Guardar cambios
                          </button>
                        </div>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- üé® Estilos -->
<style>
  /* Evita scroll horizontal en todo */
  html, body {
    overflow-x: hidden !important;
    max-width: 100%;
  }

  /* Asegura que la tabla no desborde */
  .table-responsive {
    overflow-x: auto;
    max-width: 100%;
  }

  /* Alineaci√≥n y tama√±o fijo de botones */
  .btn-accion {
    width: 120px;
    height: 38px;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    white-space: nowrap;
  }

  /* Contenedor de botones */
  .acciones-cita {
    flex-wrap: wrap;
    max-width: 100%;
  }

  /* En m√≥viles: apilados */
  @media (max-width: 576px) {
    .acciones-cita {
      flex-direction: column !important;
      align-items: stretch !important;
      gap: 0.6rem !important;
    }
    .btn-accion {
      width: 100%;
      height: auto;
      font-size: 0.95rem;
      padding: 0.5rem 0.75rem;
    }
  }

  /* Hover limpio */
  @media (min-width: 577px) {
    .btn-outline-secondary:hover {
      background-color: #dee2e6;
      color: #212529;
    }
    .btn-outline-danger:hover {
      background-color: #dc3545;
      color: #fff;
    }
  }
</style>

<%- include('partials/footer') %>
