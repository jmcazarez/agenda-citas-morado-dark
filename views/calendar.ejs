<%- include('partials/header') %>

<h2 class="mb-2 text-center fw-bold">Calendario de citas</h2>

<%
  const nombresMes = [
    'Enero','Febrero','Marzo','Abril','Mayo','Junio',
    'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'
  ];
  const ahoraMazatlan = new Date(
    new Date().toLocaleString("en-US", { timeZone: "America/Mazatlan" })
  );
  const hoyISO = ahoraMazatlan.toISOString().slice(0, 10);
%>

<!-- Encabezado -->
<div class="text-center mb-3">
  <h4 class="fw-bold text-uppercase mb-1"><%= nombresMes[month - 1] %> <%= year %></h4>
  <p class="text-muted small mb-2">ðŸ•“ Hora local: MazatlÃ¡n (GMT-7)</p>

  <% 
    let totalMes = 0;
    if (typeof citaCounts !== 'undefined') {
      for (const fecha in citaCounts) totalMes += citaCounts[fecha];
    }
  %>
  <p class="text-muted fw-semibold mb-3">
    ðŸ“… Total de citas: <span class="text-primary"><%= totalMes %></span>
  </p>

  <div class="d-flex justify-content-between align-items-center flex-column flex-sm-row gap-2">
    <form method="get" action="/mes" class="w-100 w-sm-auto">
      <input type="hidden" name="year" value="<%= month === 1 ? year - 1 : year %>">
      <input type="hidden" name="month" value="<%= month === 1 ? 12 : month - 1 %>">
      <button class="btn btn-outline-secondary w-100 rounded-pill">&laquo; Mes anterior</button>
    </form>

    <form method="get" action="/mes" class="w-100 w-sm-auto">
      <input type="hidden" name="year" value="<%= month === 12 ? year + 1 : year %>">
      <input type="hidden" name="month" value="<%= month === 12 ? 1 : month + 1 %>">
      <button class="btn btn-outline-secondary w-100 rounded-pill">Mes siguiente &raquo;</button>
    </form>
  </div>
</div>

<!-- Encabezado fijo -->
<div id="dayHeader" class="day-header sticky-top text-center fw-semibold small text-uppercase">
  <div>Dom</div><div>Lun</div><div>Mar</div><div>MiÃ©</div><div>Jue</div><div>Vie</div><div>SÃ¡b</div>
</div>

<!-- Calendario con GRID -->
<div class="calendar-grid">
  <% weeks.forEach(week => { week.forEach((day, iDia) => { %>
    <% if (!day) { %>
      <div class="day-cell empty"></div>
    <% } else { 
      const esHoy = day.isoDate === hoyISO;
      const fechaActual = new Date(day.isoDate);
      const esPasado = fechaActual < ahoraMazatlan && !esHoy;
      const esFuturo = fechaActual > ahoraMazatlan && !esHoy;
      const esDomingo = iDia === 0;
      const tieneCitas = typeof citaCounts !== 'undefined' && citaCounts[day.isoDate] > 0;
      const numCitas = tieneCitas ? citaCounts[day.isoDate] : 0;

      let bgColor = "#fff";
      let textColor = "#212529";
      let badgeHTML = "";

      if (esHoy) {
        bgColor = "#fff3cd";
        if (tieneCitas) badgeHTML = `<span class='badge bg-danger small'>${numCitas}</span>`;
      } else if (esPasado) {
        bgColor = "#dee2e6";
        textColor = "#495057";
        if (tieneCitas) badgeHTML = `<span class='badge bg-danger small'>${numCitas}</span>`;
      } else if (esFuturo && tieneCitas) {
        bgColor = "#ffffff";
        badgeHTML = `<span class='badge bg-danger small'>${numCitas}</span>`;
      } else if (esFuturo && !tieneCitas) {
        bgColor = "#e9f7ef";
        textColor = "#2d6a4f";
      }
      if (esDomingo) bgColor = "#f8f9fa";
    %>
      <div class="day-cell" style="background-color:<%= bgColor %>; color:<%= textColor %>;">
        <a href="/citas?fecha=<%= day.isoDate %>" class="day-link">
          <div class="day-number"><%= day.day %></div>
          <%- badgeHTML %>
        </a>
      </div>
    <% } %>
  <% }) }) %>
</div>

<!-- JS -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.getElementById('dayHeader');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 40) header.classList.add('scrolled');
      else header.classList.remove('scrolled');
    });
  });
</script>

<style>
  /* === GRID PERFECTO === */
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-top: 5px;
  }

  .day-cell {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    height: 90px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    font-size: 0.9rem;
    text-align: center;
  }

  .day-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: inherit;
    width: 100%;
    height: 100%;
    justify-content: center;
  }

  .day-number {
    font-weight: 600;
    margin-bottom: 4px;
  }

  .day-cell.empty {
    background-color: #f8f9fa;
  }

  /* Encabezado fijo */
  .day-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    top: 65px;
    background: #fff;
    padding: 5px 0;
    border-bottom: 1px solid #dee2e6;
    z-index: 20;
  }
  .day-header.scrolled {
    background-color: #f8f9fa;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* Responsive mÃ³vil */
  @media (max-width: 576px) {
    .day-cell {
      height: 65px;
      font-size: 0.8rem;
    }
    .calendar-grid {
      gap: 2px;
    }
    .day-header {
      top: 60px;
      font-size: 0.75rem;
    }
  }

  /* Hover */
  .day-cell:hover {
    transform: scale(1.03);
    box-shadow: 0 0 4px rgba(0,0,0,0.1);
    transition: 0.2s;
  }
</style>

<%- include('partials/footer') %>
